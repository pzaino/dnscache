---
    name: CI
    
    permissions:
      contents: read
    
    on:
      push:
        branches:
          - main
          - develop
      pull_request:
    
    jobs:
      test:
        name: Test on ${{ matrix.os }}
        runs-on: ${{ matrix.os }}
    
        strategy:
          fail-fast: false
          matrix:
            os: [ubuntu-latest, macos-latest, windows-latest]
    
        steps:
          - name: Harden the runner (Audit all outbound calls)
            uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
            with:
              egress-policy: audit

          - name: Checkout
            uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
    
          - name: Install Rust (from rust-toolchain file)
            uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
    
          - name: Cache cargo registry + target
            uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
    
          - name: Format check
            run: cargo fmt --all -- --check
    
          - name: Clippy (lint)
            run: cargo clippy --all-targets --all-features -- -D warnings
    
          - name: Build
            run: cargo build --all-targets --all-features
    
          - name: Run tests
            run: cargo test --all --all-features --verbose
    