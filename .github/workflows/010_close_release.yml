---
    name: Close Release (Rust)
    
    permissions:
      contents: write
    
    on:
      workflow_dispatch:
        inputs:
          dry_run:
            description: "Dry run (do not push tag or create release)"
            required: false
            default: "false"
          prerelease:
            description: "Mark release as pre-release"
            required: false
            default: "false"
    
    jobs:
      close-release:
        runs-on: ubuntu-latest
    
        steps:
          - name: Harden the runner (Audit outbound calls)
            uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911
            with:
              egress-policy: audit
    
          - name: Checkout repo
            uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
            with:
              fetch-depth: 0
    
          - name: Install Rust toolchain
            uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
    
          - name: Read release version
            id: get_version
            run: |
              if [ ! -f RELEASE_VERSION.txt ]; then
                echo "RELEASE_VERSION.txt not found!" && exit 1
              fi
              VERSION=$(cat RELEASE_VERSION.txt | tr -d ' \n')
              echo "version=$VERSION" >> $GITHUB_OUTPUT
              echo "Release version: $VERSION"
    
          - name: Validate version format
            run: |
              VERSION="${{ steps.get_version.outputs.version }}"
              if ! [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                echo "ERROR: Version must match vMAJOR.MINOR.PATCH (e.g., v1.2.3)"
                exit 1
              fi
    
          - name: Validate Cargo.toml version matches
            run: |
              VERSION="${{ steps.get_version.outputs.version }}"
              CARGO_VERSION=$(grep '^version' Cargo.toml | head -1 | sed -E 's/version\s*=\s*"(.*)"/\1/')
              TAG_VERSION="${VERSION#v}"
    
              echo "Cargo.toml version: $CARGO_VERSION"
              echo "Tag version:        $TAG_VERSION"
    
              if [ "$CARGO_VERSION" != "$TAG_VERSION" ]; then
                echo "ERROR: Cargo.toml version does not match RELEASE_VERSION.txt"
                exit 1
              fi
    
          - name: Ensure tag does not already exist
            run: |
              VERSION="${{ steps.get_version.outputs.version }}"
              if git rev-parse "$VERSION" >/dev/null 2>&1; then
                echo "ERROR: Tag $VERSION already exists!"
                exit 1
              fi
    
          - name: Create Git tag
            if: ${{ github.event.inputs.dry_run != 'true' }}
            run: |
              VERSION="${{ steps.get_version.outputs.version }}"
              git config user.name "github-actions"
              git config user.email "actions@github.com"
              git tag "$VERSION"
              git push origin "$VERSION"
    
          - name: Find previous tag
            id: prev
            run: |
              VERSION="${{ steps.get_version.outputs.version }}"
              PREV=$(git describe --tags --abbrev=0 "${VERSION}^" 2>/dev/null || true)
              echo "prev_tag=$PREV" >> "$GITHUB_OUTPUT"
    
          - name: Create GitHub release
            if: ${{ github.event.inputs.dry_run != 'true' }}
            uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
            with:
              tag_name: ${{ steps.get_version.outputs.version }}
              name: Release ${{ steps.get_version.outputs.version }}
              body: |
                Release ${{ steps.get_version.outputs.version }}
    
                **Full Changelog**:
                https://github.com/${{ github.repository }}/compare/${{ steps.prev.outputs.prev_tag }}...${{ steps.get_version.outputs.version }}
              generate_release_notes: true
              prerelease: ${{ github.event.inputs.prerelease }}
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
          - name: Dry run notice
            if: ${{ github.event.inputs.dry_run == 'true' }}
            run: |
              echo "[DRY RUN] Would have created Git tag and GitHub release for version ${{ steps.get_version.outputs.version }}"
    